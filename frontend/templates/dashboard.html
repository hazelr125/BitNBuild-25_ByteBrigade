<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GigCampus</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .user-name-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .user-name-btn:hover {
            background: var(--primary-dark);
        }
        .user-name-btn i {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html"><h2>GigCampus</h2></a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="services.html" class="nav-link">Services</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </div>
            <div class="nav-buttons">
                <div class="user-menu">
                    <button class="user-name-btn" id="user-name-btn">
                        <span id="nav-user-name">Loading...</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-avatar">
                        <div class="avatar-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="user-dropdown">
                        <a href="dashboard.html" class="dropdown-item active">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-user-edit"></i>
                            Profile
                        </a>
                        <a href="chat.html" class="dropdown-item">
                            <i class="fas fa-comments"></i>
                            Messages
                        </a>
                        <a href="earnings.html" class="dropdown-item">
                            <i class="fas fa-rupee-sign"></i>
                            Earnings
                        </a>
                        <a href="settings.html" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-grid">
                <!-- Sidebar -->
                <div class="dashboard-sidebar">
                    <div class="sidebar-menu">
                        <a href="dashboard.html" class="sidebar-item active">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="/templates/profile.html" class="sidebar-item">
                            <i class="fas fa-user-edit"></i>
                            <span>Profile</span>
                        </a>
                        <a href="/templates/my-services.html" class="sidebar-item">
                            <i class="fas fa-briefcase"></i>
                            <span>My Services</span>
                        </a>
                        <a href="/templates/bookings.html" class="sidebar-item">
                            <i class="fas fa-calendar-check"></i>
                            <span>Bookings</span>
                        </a>
                        <a href="messages.html" class="sidebar-item">
                            <i class="fas fa-comments"></i>
                            <span>Messages</span>
                            <span class="notification-badge">3</span>
                        </a>
                        <a href="earnings.html" class="sidebar-item">
                            <i class="fas fa-rupee-sign"></i>
                            <span>Earnings</span>
                        </a>
                        <a href="reviews.html" class="sidebar-item">
                            <i class="fas fa-star"></i>
                            <span>Reviews</span>
                        </a>
                        <a href="settings.html" class="sidebar-item">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="dashboard-main">
                    <!-- Welcome Section -->
                    <div class="dashboard-header">
                        <h1 id="welcome-message">Welcome back!</h1>
                        <p>Here's what's happening with your account today.</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-earnings">₹0</h3>
                                <p>Total Earnings</p>
                                <span class="stat-change positive">+15% this month</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="active-projects">0</h3>
                                <p>Active Projects</p>
                                <span class="stat-change positive">+3 this week</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="average-rating">0.0</h3>
                                <p>Average Rating</p>
                                <span class="stat-change positive">+0.2 this month</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3>24</h3>
                                <p>Students Helped</p>
                                <span class="stat-change positive">+5 this month</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h2>Quick Actions</h2>
                        <div class="actions-grid">
                            <a href="add-service.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <h3>Add New Service</h3>
                                <p>Offer a new skill or service</p>
                            </a>
                            <a href="browse-services.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <h3>Browse Services</h3>
                                <p>Find services you need</p>
                            </a>
                            <a href="messages.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h3>Messages</h3>
                                <p>Check your conversations</p>
                            </a>
                            <a href="earnings.html" class="action-card">
                                <div class="action-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3>View Analytics</h3>
                                <p>Track your performance</p>
                            </a>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h2>Recent Activity</h2>
                        <div class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-calendar-plus"></i>
                                </div>
                                <div class="activity-content">
                                    <h4>New booking received</h4>
                                    <p>Sarah booked your Calculus tutoring session for tomorrow</p>
                                    <span class="activity-time">2 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="activity-content">
                                    <h4>New review received</h4>
                                    <p>Rahul gave you a 5-star rating for your Physics tutoring</p>
                                    <span class="activity-time">1 day ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                                <div class="activity-content">
                                    <h4>Payment received</h4>
                                    <p>₹1,200 received for Chemistry tutoring session</p>
                                    <span class="activity-time">2 days ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <div class="activity-content">
                                    <h4>New message</h4>
                                    <p>Priya sent you a message about her upcoming exam</p>
                                    <span class="activity-time">3 days ago</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Bookings -->
                    <div class="upcoming-bookings">
                        <h2>Upcoming Bookings</h2>
                        <div class="bookings-list">
                            <div class="booking-item">
                                <div class="booking-info">
                                    <h4>Calculus Tutoring</h4>
                                    <p>with Sarah Chen</p>
                                    <span class="booking-time">Tomorrow, 2:00 PM</span>
                                </div>
                                <div class="booking-actions">
                                    <button class="btn-primary btn-small">View Details</button>
                                </div>
                            </div>
                            <div class="booking-item">
                                <div class="booking-info">
                                    <h4>Physics Problem Solving</h4>
                                    <p>with Rahul Kumar</p>
                                    <span class="booking-time">Friday, 4:00 PM</span>
                                </div>
                                <div class="booking-actions">
                                    <button class="btn-primary btn-small">View Details</button>
                                </div>
                            </div>
                            <div class="booking-item">
                                <div class="booking-info">
                                    <h4>Chemistry Lab Help</h4>
                                    <p>with Ananya Singh</p>
                                    <span class="booking-time">Saturday, 10:00 AM</span>
                                </div>
                                <div class="booking-actions">
                                    <button class="btn-primary btn-small">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>GigCampus</h3>
                    <p>Connecting students across India to create opportunities and build communities.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="academic-tutoring.html">Tutoring</a></li>
                        <li><a href="creative-design.html">Design</a></li>
                        <li><a href="tech-services.html">Programming</a></li>
                        <li><a href="photography.html">Photography</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Safety</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="#">hello@gigcampus.in</a></li>
                        <li><a href="#">+91 98765 43210</a></li>
                        <li><a href="#">Mumbai, Maharashtra</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 GigCampus. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/script.js"></script>
    
    <script>
        // Dashboard specific JavaScript
        document.addEventListener('DOMContentLoaded', async () => {
            // Immediate debugging
            console.log('🔄 Dashboard loading...');
            console.log('Window object keys:', Object.keys(window));
            console.log('API object exists:', typeof window.api !== 'undefined');
            
            // Check if api object exists
            if (typeof api === 'undefined') {
                console.error('❌ API object not found! Scripts may not have loaded properly.');
                const welcomeMessage = document.getElementById('welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.textContent = 'Welcome back! (Scripts loading...)';
                }
                
                // Try to wait for scripts to load
                setTimeout(() => {
                    if (typeof api !== 'undefined') {
                        console.log('✅ API object found after delay, reloading...');
                        location.reload();
                    } else {
                        console.error('❌ API still not available after delay');
                        if (welcomeMessage) {
                            welcomeMessage.textContent = 'Welcome back, User!';
                        }
                    }
                }, 1000);
                return;
            }
            
            console.log('✅ API object found:', api);
            console.log('API functions available:', {
                isAuthenticated: typeof api.isAuthenticated,
                getProfile: typeof api.getProfile,
                token: typeof api.token
            });
            
            // Check if user is authenticated
            console.log('Dashboard loading - checking authentication');
            const authStatus = {
                isAuthenticated: api.isAuthenticated(),
                token: api.token,
                hasToken: !!api.token,
                tokenLength: api.token ? api.token.length : 0
            };
            console.log('Auth details:', authStatus);
            
            // Set a default name immediately
            const welcomeMessage = document.getElementById('welcome-message');
            const navUserName = document.getElementById('nav-user-name');
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 'Welcome back, Loading...';
                console.log('✅ Set loading message');
            } else {
                console.error('❌ Welcome message element not found!');
            }
            
            // Set initial navigation user name
            if (navUserName) {
                navUserName.textContent = 'Loading...';
                console.log('✅ Set loading navigation user name');
            }
            
            if (!api.isAuthenticated()) {
                console.log('❌ User not authenticated, redirecting to login');
                if (welcomeMessage) {
                    welcomeMessage.textContent = 'Welcome back! Please sign in...';
                }
                showNotification('Please sign in to access your dashboard', 'warning');
                setTimeout(() => {
                    window.location.href = '/templates/signin.html';
                }, 2000);
                return;
            }
            console.log('✅ User is authenticated, loading dashboard data');

            try {
                // Show loading state
                showLoading(true);
                
                // Always fetch fresh user data from API
                console.log('🔄 Fetching fresh user data from API...');
                let userProfile = null;
                
                try {
                    userProfile = await api.getProfile();
                    // Store fresh data in localStorage
                    localStorage.setItem('userInfo', JSON.stringify(userProfile));
                    console.log('✅ Fresh user data loaded and cached:', userProfile);
                } catch (apiError) {
                    console.log('❌ API call failed:', apiError.message);
                    
                    // Only fall back to cache if API completely fails
                    const cachedUserInfo = localStorage.getItem('userInfo');
                    if (cachedUserInfo) {
                        try {
                            userProfile = JSON.parse(cachedUserInfo);
                            console.log('⚠️ Using cached user info as fallback:', userProfile);
                        } catch (e) {
                            console.log('⚠️ Cached data also invalid');
                        }
                    }
                    
                    if (!userProfile) {
                        throw apiError;
                    }
                }
                
                console.log('User profile:', userProfile);
                
                // Validate userProfile exists
                if (!userProfile) {
                    throw new Error('User profile is null or undefined');
                }
                
                console.log('Profile keys:', Object.keys(userProfile));
                console.log('firstName value:', userProfile.firstName, typeof userProfile.firstName);
                console.log('lastName value:', userProfile.lastName, typeof userProfile.lastName);
                console.log('username value:', userProfile.username, typeof userProfile.username);
                
                // Update welcome message
                const welcomeMessage = document.getElementById('welcome-message');
                
                // Try multiple ways to get the name with better validation
                let userName = 'User'; // Default fallback
                
                if (userProfile.firstName && 
                    userProfile.firstName !== 'undefined' && 
                    userProfile.firstName.trim() !== '') {
                    userName = `${userProfile.firstName} ${userProfile.lastName || ''}`.trim();
                    console.log('✅ Using firstName + lastName:', userName);
                } else if (userProfile.first_name && 
                          userProfile.first_name !== 'undefined' && 
                          userProfile.first_name.trim() !== '') {
                    userName = `${userProfile.first_name} ${userProfile.last_name || ''}`.trim();
                    console.log('✅ Using first_name + last_name:', userName);
                } else if (userProfile.username && 
                          userProfile.username !== 'undefined' && 
                          userProfile.username.trim() !== '') {
                    userName = userProfile.username;
                    console.log('✅ Using username:', userName);
                } else {
                    console.log('⚠️ Using fallback name');
                }
                
                console.log('Final userName:', userName);
                
                // Ensure welcomeMessage element exists and update it
                if (welcomeMessage) {
                    welcomeMessage.textContent = `Welcome back, ${userName}!`;
                    console.log('✅ Welcome message updated to:', `Welcome back, ${userName}!`);
                } else {
                    console.error('❌ Welcome message element not found');
                }
                
                // Update navigation (auth.js will handle this)
                if (typeof window.authHandler !== 'undefined' && window.authHandler.updateNavigation) {
                    window.authHandler.updateNavigation();
                    console.log('✅ Updated navigation via auth handler');
                } else {
                    console.log('⚠️ Auth handler not available, updating navigation manually');
                    // Fallback: update navigation manually
                    const navUserName = document.getElementById('nav-user-name');
                    if (navUserName) {
                        navUserName.textContent = userName || 'User'; // Full name for nav
                        console.log('✅ Navigation user name updated to:', userName);
                    }
                }
                
                // Update user stats with fallback values
                const totalEarningsEl = document.getElementById('total-earnings');
                const activeProjectsEl = document.getElementById('active-projects');
                const averageRatingEl = document.getElementById('average-rating');
                
                // Try to load stats from API, but don't fail if it doesn't work
                let userStats = { totalEarnings: 0, activeProjects: 0, reputation: 4.5 };
                try {
                    if (typeof api.getUserStats === 'function') {
                        userStats = await api.getUserStats();
                        console.log('✅ Loaded user stats:', userStats);
                    }
                } catch (statsError) {
                    console.log('⚠️ Using default stats due to API error:', statsError.message);
                }
                
                if (totalEarningsEl) totalEarningsEl.textContent = `₹${userStats.totalEarnings || 0}`;
                if (averageRatingEl) averageRatingEl.textContent = userStats.reputation ? userStats.reputation.toFixed(1) : '4.5';
                if (activeProjectsEl) activeProjectsEl.textContent = userStats.activeProjects || 0;
                
                showLoading(false);
                showNotification(`Welcome back, ${userName}!`, 'success');
                
                // Force update navigation after everything is loaded
                setTimeout(() => {
                    if (typeof window.authHandler !== 'undefined' && window.authHandler.updateNavigation) {
                        window.authHandler.updateNavigation();
                        console.log('✅ Force updated navigation after dashboard load');
                    }
                }, 500);
                
            } catch (error) {
                showLoading(false);
                console.error('❌ Dashboard load error:', error);
                
                // Set a fallback name even when API calls fail
                const welcomeMessage = document.getElementById('welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.textContent = 'Welcome back, User!';
                    console.log('✅ Set fallback welcome message due to API error');
                }
                
                // Also set fallback for navigation
                const navUserName = document.getElementById('nav-user-name');
                if (navUserName) {
                    navUserName.textContent = 'User';
                    console.log('✅ Set fallback navigation user name');
                }
                
                // Show detailed error for debugging
                console.log('Error details:', {
                    message: error.message,
                    token: api.token,
                    hasToken: !!api.token
                });
                
                if (error.message.includes('401') || error.message.includes('Unauthorized') || error.message.includes('Invalid token')) {
                    showNotification('Session expired. Please sign in again.', 'error');
                    // Clear invalid token
                    api.clearToken();
                    setTimeout(() => {
                        window.location.href = '/templates/signin.html';
                    }, 2000);
                } else {
                    showNotification(`Error loading dashboard data: ${error.message}`, 'error');
                }
            }
        });
    </script>
</body>
</html>
